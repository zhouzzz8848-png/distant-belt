<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è‹±è¯­çŸ­æ–‡è¯­å¢ƒé˜…è¯»</title>
    <meta name="description" content="ä½¿ç”¨AIç”Ÿæˆè‹±è¯­çŸ­æ–‡ï¼Œåœ¨è¯­å¢ƒä¸­å­¦ä¹ è¯æ±‡">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' },
                        accent: { 50: '#fdf4ff', 100: '#fae8ff', 200: '#f5d0fe', 300: '#f0abfc', 400: '#e879f9', 500: '#d946ef', 600: '#c026d3', 700: '#a21caf', 800: '#86198f', 900: '#701a75' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.15); }
        .glass-light { background: rgba(255,255,255,0.12); }
        .glow { box-shadow: 0 0 30px rgba(139,92,246,0.3); }
        .btn-glow:hover { box-shadow: 0 0 25px rgba(139,92,246,0.5); transform: translateY(-2px); }
        .word-tag { transition: all 0.2s; }
        .word-tag:hover { transform: scale(1.05); }
        .word-tag.selected { background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing { border-right: 2px solid #8b5cf6; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { border-color: #8b5cf6; } 51%, 100% { border-color: transparent; } }
        .article-content { line-height: 2; letter-spacing: 0.02em; }
        .highlight-word { background: linear-gradient(135deg, rgba(139,92,246,0.3), rgba(236,72,153,0.3)); padding: 2px 6px; border-radius: 4px; font-weight: 600; cursor: help; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.5); border-radius: 4px; }
        .collection-card { transition: all 0.3s; }
        .collection-card:hover { transform: translateX(5px); background: rgba(255,255,255,0.15); }
        select option { background: #1e1b4b; color: white; padding: 8px; }
        select { color: white; }
        /* Toast æç¤ºæ ·å¼ */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(139,92,246,0.9); backdrop-filter: blur(10px); padding: 12px 24px; border-radius: 12px; z-index: 1000; transition: transform 0.3s ease; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .glass { backdrop-filter: blur(10px); }
            main { padding: 1rem; }
            h1 { font-size: 1rem; }
        }
        /* å¿«æ·é”®æç¤º */
        .shortcut-hint { opacity: 0.6; font-size: 0.75rem; }
    </style>
</head>
<body class="text-white">
    <!-- Toast æç¤ºå®¹å™¨ -->
    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <nav class="glass sticky top-0 z-50 px-4 md:px-6 py-3 md:py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 md:gap-3">
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-xl bg-gradient-to-br from-violet-500 to-pink-500 flex items-center justify-center text-lg md:text-xl">ğŸ“š</div>
                <h1 class="text-lg md:text-xl font-bold bg-gradient-to-r from-violet-400 to-pink-400 bg-clip-text text-transparent">AI è‹±è¯­è¯­å¢ƒé˜…è¯»</h1>
            </div>
            <div class="flex gap-2 md:gap-3">
                <button onclick="showDevModal()" class="px-3 md:px-4 py-2 rounded-lg glass hover:glass-light transition-all text-xs md:text-sm">ç™»å½•</button>
                <button onclick="showDevModal()" class="px-3 md:px-4 py-2 rounded-lg bg-gradient-to-r from-violet-600 to-pink-600 hover:from-violet-500 hover:to-pink-500 transition-all text-xs md:text-sm btn-glow">æ³¨å†Œ</button>
            </div>
        </div>
    </nav>
    <main class="max-w-7xl mx-auto px-4 md:px-6 py-6 md:py-8">
        <div class="grid lg:grid-cols-3 gap-4 md:gap-6">
            <div class="lg:col-span-1 space-y-4 md:space-y-6">
                <!-- API é…ç½®ï¼ˆå¯æŠ˜å ï¼‰ -->
                <section class="glass rounded-2xl overflow-hidden">
                    <button onclick="toggleApiConfig()" class="w-full p-4 flex items-center justify-between hover:bg-white/5 transition-all">
                        <div class="flex items-center gap-2">
                            <span class="text-xl md:text-2xl">âš™ï¸</span>
                            <span class="font-semibold text-sm md:text-base">API é…ç½®</span>
                            <span id="apiStatus" class="text-xs px-2 py-0.5 bg-yellow-600/50 rounded-full">æœªé…ç½®</span>
                        </div>
                        <span id="apiToggleIcon" class="text-gray-400 transition-transform">â–¼</span>
                    </button>
                    <div id="apiConfigPanel" class="hidden px-4 md:px-6 pb-4 md:pb-6 space-y-4 fade-in">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">é€‰æ‹©æ¨¡å‹æä¾›å•†</label>
                            <select id="providerSelect" onchange="onProviderChange()" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-violet-500 transition-all">
                                <option value="siliconflow">ç¡…åŸºæµåŠ¨ (SiliconCloud)</option>
                                <option value="dashscope">é€šä¹‰åƒé—® (DashScope)</option>
                                <option value="deepseek">æ·±åº¦æ±‚ç´¢ (DeepSeek)</option>
                                <option value="custom">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">API åœ°å€</label>
                            <input type="text" id="apiUrl" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-violet-500 transition-all text-sm" placeholder="API endpoint URL">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">æ¨¡å‹åç§°</label>
                            <select id="modelSelect" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-violet-500 transition-all"></select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">API Key <span class="text-xs text-gray-500">(æœ¬åœ°ä¿å­˜)</span></label>
                            <input type="password" id="apiKey" oninput="saveApiKey()" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-violet-500 transition-all" placeholder="è¾“å…¥æ‚¨çš„ API Key">
                        </div>
                    </div>
                </section>

                <!-- è¯æ±‡é€‰æ‹© -->
                <section class="glass rounded-2xl p-4 md:p-6">
                    <h2 class="text-base md:text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-xl md:text-2xl">ğŸ“–</span> è¯æ±‡é€‰æ‹©
                        <span id="vocabCount" class="text-xs px-2 py-0.5 bg-violet-600/30 rounded-full ml-auto">0 è¯</span>
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">è¯æ±‡ä¹¦</label>
                            <select id="vocabBook" onchange="loadVocabulary()" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-violet-500 transition-all">
                                <option value="CET4_T.json">å››çº§æ ¸å¿ƒè¯æ±‡</option>
                                <option value="CET6_T.json">å…­çº§æ ¸å¿ƒè¯æ±‡</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">éšæœºè¯æ±‡æ•°é‡</label>
                            <select id="wordCountSelect" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-violet-500 transition-all">
                                <option value="3">3 ä¸ªè¯æ±‡</option>
                                <option value="5" selected>5 ä¸ªè¯æ±‡</option>
                                <option value="7">7 ä¸ªè¯æ±‡</option>
                                <option value="10">10 ä¸ªè¯æ±‡</option>
                            </select>
                        </div>
                        <button onclick="randomSelectWords()" id="randomBtn" class="w-full py-3 rounded-xl bg-gradient-to-r from-pink-600 to-violet-600 hover:from-pink-500 hover:to-violet-500 transition-all font-semibold btn-glow flex items-center justify-center gap-2">
                            <span>ğŸ²</span> AI éšæœºé€‰è¯
                        </button>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm text-gray-300">å·²é€‰è¯æ±‡ (<span id="selectedCount">0</span>)</label>
                                <button onclick="clearSelectedWords()" class="text-xs text-red-400 hover:text-red-300">æ¸…ç©º</button>
                            </div>
                            <div id="selectedWords" class="flex flex-wrap gap-2 min-h-[80px] p-3 bg-white/5 rounded-xl border border-white/10">
                                <p class="text-gray-400 text-sm">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®éšæœºé€‰è¯</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="lg:col-span-2 space-y-4 md:space-y-6">
                <!-- çŸ­æ–‡ç”Ÿæˆ -->
                <section class="glass rounded-2xl p-4 md:p-6">
                    <h2 class="text-base md:text-lg font-semibold mb-4 flex items-center gap-2"><span class="text-xl md:text-2xl">âœ¨</span> çŸ­æ–‡ç”Ÿæˆ</h2>
                    <div class="grid grid-cols-2 gap-3 md:gap-4 mb-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">æ–‡ç« ç±»å‹</label>
                            <select id="articleType" class="w-full bg-white/10 border border-white/20 rounded-xl px-3 md:px-4 py-3 focus:outline-none focus:border-violet-500 transition-all text-sm">
                                <option value="story">æ•…äº‹å™è¿°</option>
                                <option value="news">æ–°é—»æŠ¥é“</option>
                                <option value="essay">è®®è®ºæ–‡</option>
                                <option value="dialog">å¯¹è¯åœºæ™¯</option>
                                <option value="letter">ä¹¦ä¿¡é‚®ä»¶</option>
                                <option value="random">AIè‡ªé€‰</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">å­—æ•°è¦æ±‚</label>
                            <select id="wordCount" class="w-full bg-white/10 border border-white/20 rounded-xl px-3 md:px-4 py-3 focus:outline-none focus:border-violet-500 transition-all text-sm">
                                <option value="100">çº¦100è¯</option>
                                <option value="200" selected>çº¦200è¯</option>
                                <option value="300">çº¦300è¯</option>
                                <option value="500">çº¦500è¯</option>
                                <option value="random">AIè‡ªé€‰</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm text-gray-300">æç¤ºè¯æ¨¡æ¿</label>
                            <button onclick="toggleCustomPrompt()" class="text-xs text-violet-400 hover:text-violet-300">è‡ªå®šä¹‰</button>
                        </div>
                        <select id="promptTemplate" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-violet-500 transition-all text-sm">
                            <option value="default">é»˜è®¤æ¨¡æ¿ - è‡ªç„¶èå…¥è¯æ±‡</option>
                            <option value="highlight">é«˜äº®æ¨¡æ¿ - æ ‡æ³¨ç›®æ ‡è¯æ±‡</option>
                            <option value="explain">è§£é‡Šæ¨¡æ¿ - é™„å¸¦è¯æ±‡é‡Šä¹‰</option>
                        </select>
                    </div>
                    <div id="customPromptArea" class="hidden mb-4">
                        <label class="block text-sm text-gray-300 mb-2">è‡ªå®šä¹‰æç¤ºè¯</label>
                        <textarea id="customPrompt" rows="4" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-violet-500 transition-all text-sm" placeholder="è¯·æ ¹æ®ä»¥ä¸‹è¯æ±‡ç”Ÿæˆè‹±è¯­çŸ­æ–‡...&#10;ä½¿ç”¨ {words} ä»£è¡¨é€‰ä¸­çš„è¯æ±‡&#10;ä½¿ç”¨ {type} ä»£è¡¨æ–‡ç« ç±»å‹&#10;ä½¿ç”¨ {count} ä»£è¡¨å­—æ•°"></textarea>
                    </div>
                    <button onclick="generateArticle()" id="generateBtn" class="w-full py-4 rounded-xl bg-gradient-to-r from-violet-600 to-pink-600 hover:from-violet-500 hover:to-pink-500 transition-all font-semibold text-base md:text-lg btn-glow flex items-center justify-center gap-2">
                        <span>ğŸš€</span> ç”ŸæˆçŸ­æ–‡ <span class="shortcut-hint hidden md:inline">(Ctrl+Enter)</span>
                    </button>
                </section>

                <!-- ç”Ÿæˆç»“æœ -->
                <section id="resultSection" class="glass rounded-2xl p-4 md:p-6 hidden fade-in">
                    <div class="flex flex-wrap justify-between items-center gap-2 mb-4">
                        <h2 class="text-base md:text-lg font-semibold flex items-center gap-2"><span class="text-xl md:text-2xl">ğŸ“„</span> ç”Ÿæˆç»“æœ</h2>
                        <div class="flex gap-2">
                            <button onclick="copyArticle()" class="px-3 md:px-4 py-2 bg-purple-600/50 rounded-lg text-xs md:text-sm hover:bg-purple-600 transition-all flex items-center gap-1">ğŸ“‹ å¤åˆ¶</button>
                            <button onclick="saveToCollection()" class="px-3 md:px-4 py-2 bg-green-600/50 rounded-lg text-xs md:text-sm hover:bg-green-600 transition-all flex items-center gap-1">ğŸ’¾ æ”¶è—</button>
                            <button onclick="downloadArticle()" class="px-3 md:px-4 py-2 bg-blue-600/50 rounded-lg text-xs md:text-sm hover:bg-blue-600 transition-all flex items-center gap-1">ğŸ“¥ ä¸‹è½½</button>
                        </div>
                    </div>
                    <div id="articleResult" class="article-content text-gray-200 bg-white/5 rounded-xl p-4 md:p-6 leading-relaxed text-sm md:text-base"></div>
                    <div id="usedWords" class="mt-4 pt-4 border-t border-white/10">
                        <p class="text-sm text-gray-400 mb-2">ä½¿ç”¨çš„ç›®æ ‡è¯æ±‡ï¼š</p>
                        <div id="usedWordsList" class="flex flex-wrap gap-2"></div>
                    </div>
                </section>

                <!-- æˆ‘çš„æ”¶è— -->
                <section class="glass rounded-2xl p-4 md:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-base md:text-lg font-semibold flex items-center gap-2">
                            <span class="text-xl md:text-2xl">â­</span> æˆ‘çš„æ”¶è—
                            <span id="collectionCount" class="text-xs px-2 py-0.5 bg-violet-600/30 rounded-full">0</span>
                        </h2>
                        <button onclick="clearAllCollections()" class="text-xs text-red-400 hover:text-red-300">æ¸…ç©ºå…¨éƒ¨</button>
                    </div>
                    <div id="collectionList" class="space-y-3 max-h-[400px] overflow-y-auto">
                        <p class="text-gray-400 text-sm text-center py-8">æš‚æ— æ”¶è—å†…å®¹</p>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- å¸®åŠ©æç¤º -->
    <footer class="text-center py-4 text-gray-500 text-xs">
        <p>ğŸ’¡ æç¤ºï¼šé€‰å¥½è¯æ±‡åæŒ‰ <kbd class="px-1.5 py-0.5 bg-white/10 rounded">Ctrl</kbd> + <kbd class="px-1.5 py-0.5 bg-white/10 rounded">Enter</kbd> å¿«é€Ÿç”Ÿæˆ</p>
    </footer>

    <!-- å¼€å‘ä¸­å¼¹çª— -->
    <div id="devModal" class="fixed inset-0 bg-black/60 backdrop-filter backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="glass rounded-2xl p-6 md:p-8 max-w-sm text-center fade-in mx-4">
            <div class="text-5xl md:text-6xl mb-4">ğŸš§</div>
            <h3 class="text-lg md:text-xl font-semibold mb-2">åŠŸèƒ½å¼€å‘ä¸­</h3>
            <p class="text-gray-300 mb-6 text-sm md:text-base">ç”¨æˆ·ç³»ç»Ÿæ­£åœ¨ç´§å¼ å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼</p>
            <button onclick="hideDevModal()" class="px-6 py-2 bg-violet-600 rounded-xl hover:bg-violet-500 transition-all">çŸ¥é“äº†</button>
        </div>
    </div>

    <script>
    /**
     * ============================================
     * AI è‹±è¯­çŸ­æ–‡è¯­å¢ƒé˜…è¯» - é…ç½®è¯´æ˜
     * ============================================
     * ã€å¦‚ä½•æ·»åŠ æ–°è¯åº“ã€‘
     * 1. å°†è¯åº“ JSON æ–‡ä»¶ä¸Šä¼ åˆ°ç½‘ç«™æ ¹ç›®å½•
     * 2. JSON æ ¼å¼: [{"name": "å•è¯", "trans": ["é‡Šä¹‰"]}, ...]
     * 3. åœ¨ vocabBook ä¸‹æ‹‰èœå•æ·»åŠ å¯¹åº”é€‰é¡¹
     * 
     * ã€å¦‚ä½•æ·»åŠ æ–°çš„ API æä¾›å•†ã€‘
     * 1. åœ¨ PROVIDERS å¯¹è±¡ä¸­æ·»åŠ æ–°é…ç½®
     * 2. åœ¨ providerSelect ä¸‹æ‹‰èœå•æ·»åŠ å¯¹åº”é€‰é¡¹
     */

    const VOCAB_FILES = {
        'CET4_T.json': { name: 'å››çº§æ ¸å¿ƒè¯æ±‡', file: 'CET4_T.json' },
        'CET6_T.json': { name: 'å…­çº§æ ¸å¿ƒè¯æ±‡', file: 'CET6_T.json' }
    };

    const PROVIDERS = {
        siliconflow: { name: 'ç¡…åŸºæµåŠ¨', url: 'https://api.siliconflow.cn/v1/chat/completions', models: [{ id: 'Qwen/Qwen2.5-7B-Instruct', name: 'Qwen2.5-7B-Instruct' }, { id: 'Qwen/Qwen2.5-72B-Instruct', name: 'Qwen2.5-72B-Instruct' }, { id: 'deepseek-ai/DeepSeek-V2.5', name: 'DeepSeek-V2.5' }, { id: 'THUDM/glm-4-9b-chat', name: 'GLM-4-9B' }] },
        dashscope: { name: 'é€šä¹‰åƒé—®', url: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', models: [{ id: 'qwen-turbo', name: 'Qwen-Turbo' }, { id: 'qwen-plus', name: 'Qwen-Plus' }, { id: 'qwen-max', name: 'Qwen-Max' }] },
        deepseek: { name: 'æ·±åº¦æ±‚ç´¢', url: 'https://api.deepseek.com/v1/chat/completions', models: [{ id: 'deepseek-chat', name: 'DeepSeek-Chat' }, { id: 'deepseek-coder', name: 'DeepSeek-Coder' }] },
        custom: { name: 'è‡ªå®šä¹‰', url: '', models: [{ id: 'custom', name: 'è‡ªå®šä¹‰æ¨¡å‹' }] }
    };

    const PROMPT_TEMPLATES = {
        default: `Please write an English {type} of approximately {count} words. Naturally incorporate the following vocabulary words into the text: {words}. Make sure the context helps readers understand the meaning of each word. The article should be engaging and easy to follow.`,
        highlight: `Please write an English {type} of approximately {count} words using these vocabulary words: {words}. Mark each target vocabulary word by wrapping it with double asterisks like **word**. Ensure the context clearly demonstrates the meaning of each word.`,
        explain: `Please write an English {type} of approximately {count} words. Include these vocabulary words: {words}. After the main text, provide a "Vocabulary Guide" section that lists each target word with its meaning and how it was used in the article.`
    };

    // çŠ¶æ€å˜é‡
    let currentVocabList = [];
    let selectedWords = [];
    let currentArticle = '';
    let collections = JSON.parse(localStorage.getItem('ai_reader_collections') || '[]');

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        loadSavedApiKey();
        onProviderChange();
        loadVocabulary();
        renderCollections();
        setupKeyboardShortcuts();
    });

    // é”®ç›˜å¿«æ·é”®
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                generateArticle();
            }
        });
    }

    // Toast æç¤º
    function showToast(message, duration = 2000) {
        const toast = document.getElementById('toast');
        document.getElementById('toastMessage').textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    }

    // ä¿å­˜/åŠ è½½ API Key
    function saveApiKey() {
        const apiKey = document.getElementById('apiKey').value;
        const provider = document.getElementById('providerSelect').value;
        localStorage.setItem(`ai_reader_apikey_${provider}`, apiKey);
        updateApiStatus();
    }

    function loadSavedApiKey() {
        const provider = document.getElementById('providerSelect').value;
        const savedKey = localStorage.getItem(`ai_reader_apikey_${provider}`) || '';
        document.getElementById('apiKey').value = savedKey;
        updateApiStatus();
    }

    // åŠ è½½è¯åº“
    async function loadVocabulary() {
        const vocabFile = document.getElementById('vocabBook').value;
        const btn = document.getElementById('randomBtn');
        const countEl = document.getElementById('vocabCount');
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<span class="typing">åŠ è½½è¯åº“ä¸­...</span>';
            countEl.textContent = 'åŠ è½½ä¸­...';
            
            const response = await fetch(vocabFile);
            if (!response.ok) throw new Error('è¯åº“æ–‡ä»¶åŠ è½½å¤±è´¥');
            
            const data = await response.json();
            currentVocabList = data.map(item => item.name);
            
            btn.disabled = false;
            btn.innerHTML = '<span>ğŸ²</span> AI éšæœºé€‰è¯';
            countEl.textContent = `${currentVocabList.length} è¯`;
            
            selectedWords = [];
            updateSelectedWords();
            
            showToast(`âœ… å·²åŠ è½½ ${currentVocabList.length} ä¸ªè¯æ±‡`);
        } catch (error) {
            console.error('åŠ è½½è¯åº“å¤±è´¥:', error);
            btn.innerHTML = '<span>âŒ</span> åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
            btn.disabled = false;
            countEl.textContent = 'åŠ è½½å¤±è´¥';
            currentVocabList = [];
        }
    }

    // éšæœºé€‰è¯
    function randomSelectWords() {
        if (currentVocabList.length === 0) {
            showToast('âš ï¸ è¯åº“å°šæœªåŠ è½½ï¼Œè¯·ç¨å€™');
            return;
        }
        
        const count = parseInt(document.getElementById('wordCountSelect').value);
        const shuffled = [...currentVocabList].sort(() => Math.random() - 0.5);
        selectedWords = shuffled.slice(0, Math.min(count, currentVocabList.length));
        updateSelectedWords();
        showToast(`ğŸ² å·²éšæœºé€‰æ‹© ${selectedWords.length} ä¸ªè¯æ±‡`);
    }

    function clearSelectedWords() {
        selectedWords = [];
        updateSelectedWords();
    }

    function removeWord(word) {
        selectedWords = selectedWords.filter(w => w !== word);
        updateSelectedWords();
    }

    function updateSelectedWords() {
        const container = document.getElementById('selectedWords');
        document.getElementById('selectedCount').textContent = selectedWords.length;
        
        if (selectedWords.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-sm">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®éšæœºé€‰è¯</p>';
        } else {
            container.innerHTML = selectedWords.map(w => 
                `<span class="word-tag selected px-3 py-1 rounded-full text-sm cursor-pointer" onclick="removeWord('${w}')">${w} Ã—</span>`
            ).join('');
        }
    }

    function onProviderChange() {
        const p = document.getElementById('providerSelect').value;
        const c = PROVIDERS[p];
        document.getElementById('apiUrl').value = c.url;
        document.getElementById('apiUrl').disabled = p !== 'custom';
        document.getElementById('modelSelect').innerHTML = c.models.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        loadSavedApiKey();
    }

    function toggleApiConfig() {
        const panel = document.getElementById('apiConfigPanel');
        const icon = document.getElementById('apiToggleIcon');
        panel.classList.toggle('hidden');
        icon.style.transform = panel.classList.contains('hidden') ? '' : 'rotate(180deg)';
    }

    function updateApiStatus() {
        const apiKey = document.getElementById('apiKey').value;
        const status = document.getElementById('apiStatus');
        if (apiKey) {
            status.textContent = 'å·²é…ç½®';
            status.className = 'text-xs px-2 py-0.5 bg-green-600/50 rounded-full';
        } else {
            status.textContent = 'æœªé…ç½®';
            status.className = 'text-xs px-2 py-0.5 bg-yellow-600/50 rounded-full';
        }
    }

    function toggleCustomPrompt() {
        document.getElementById('customPromptArea').classList.toggle('hidden');
    }

    async function generateArticle() {
        if (selectedWords.length === 0) {
            showToast('âš ï¸ è¯·å…ˆé€‰æ‹©è¯æ±‡');
            return;
        }
        
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey) {
            showToast('âš ï¸ è¯·å…ˆé…ç½® API Key');
            toggleApiConfig();
            return;
        }
        
        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="typing">æ­£åœ¨ç”Ÿæˆä¸­...</span>';
        
        try {
            const url = document.getElementById('apiUrl').value;
            const model = document.getElementById('modelSelect').value;
            const tpl = document.getElementById('promptTemplate').value;
            const customPrompt = document.getElementById('customPrompt').value;
            const articleType = document.getElementById('articleType').value;
            const wordCountVal = document.getElementById('wordCount').value;
            
            const typeMap = {
                story: 'narrative story', news: 'news article', essay: 'argumentative essay',
                dialog: 'dialogue', letter: 'letter or email', random: 'piece of writing (you choose the style)'
            };
            const countMap = { '100': '100', '200': '200', '300': '300', '500': '500', random: '150-300' };
            
            let prompt = customPrompt || PROMPT_TEMPLATES[tpl];
            prompt = prompt.replace('{words}', selectedWords.join(', ')).replace('{type}', typeMap[articleType] || articleType).replace('{count}', countMap[wordCountVal] || wordCountVal);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model, messages: [{ role: 'user', content: prompt }], temperature: 0.7 })
            });
            
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`APIé”™è¯¯: ${response.status}`);
            }
            
            const data = await response.json();
            currentArticle = data.choices?.[0]?.message?.content || 'ç”Ÿæˆå¤±è´¥';
            
            let displayContent = currentArticle;
            selectedWords.forEach(word => {
                const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                displayContent = displayContent.replace(regex, '<span class="highlight-word">$1</span>');
            });
            
            document.getElementById('articleResult').innerHTML = displayContent;
            document.getElementById('usedWordsList').innerHTML = selectedWords.map(w => 
                `<span class="px-3 py-1 bg-gradient-to-r from-violet-600/50 to-pink-600/50 rounded-full text-sm">${w}</span>`
            ).join('');
            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
            
            showToast('âœ… çŸ­æ–‡ç”ŸæˆæˆåŠŸï¼');
        } catch (error) {
            showToast('âŒ ' + error.message);
            console.error(error);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span>ğŸš€</span> ç”ŸæˆçŸ­æ–‡ <span class="shortcut-hint hidden md:inline">(Ctrl+Enter)</span>';
        }
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    async function copyArticle() {
        if (!currentArticle) return;
        try {
            await navigator.clipboard.writeText(currentArticle);
            showToast('ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        } catch (e) {
            showToast('âŒ å¤åˆ¶å¤±è´¥');
        }
    }

    function saveToCollection() {
        if (!currentArticle) return;
        
        collections.unshift({
            id: Date.now(),
            date: new Date().toLocaleDateString('zh-CN'),
            words: [...selectedWords],
            article: currentArticle,
            type: document.getElementById('articleType').value
        });
        
        localStorage.setItem('ai_reader_collections', JSON.stringify(collections));
        renderCollections();
        showToast('ğŸ’¾ å·²ä¿å­˜åˆ°æ”¶è—');
    }

    function downloadArticle() {
        if (!currentArticle) return;
        
        const content = `AI English Reading\n${'='.repeat(50)}\nDate: ${new Date().toLocaleString()}\nWords: ${selectedWords.join(', ')}\n${'='.repeat(50)}\n\n${currentArticle}`;
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ai-reading-${Date.now()}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('ğŸ“¥ å·²ä¸‹è½½åˆ°æœ¬åœ°');
    }

    function renderCollections() {
        const container = document.getElementById('collectionList');
        document.getElementById('collectionCount').textContent = collections.length;
        
        if (!collections.length) {
            container.innerHTML = '<p class="text-gray-400 text-sm text-center py-8">æš‚æ— æ”¶è—å†…å®¹</p>';
            return;
        }
        
        container.innerHTML = collections.map(item => `
            <div class="collection-card p-3 md:p-4 bg-white/5 rounded-xl border border-white/10 cursor-pointer" onclick="viewCollection(${item.id})">
                <div class="flex justify-between items-start gap-2">
                    <div class="flex-1 min-w-0">
                        <p class="text-xs md:text-sm text-gray-400">${item.date}</p>
                        <p class="text-gray-200 mt-1 text-sm line-clamp-2">${item.article.substring(0, 80)}...</p>
                        <div class="flex gap-1 mt-2 flex-wrap">
                            ${item.words.slice(0, 3).map(w => `<span class="text-xs px-2 py-0.5 bg-violet-600/30 rounded">${w}</span>`).join('')}
                            ${item.words.length > 3 ? `<span class="text-xs text-gray-400">+${item.words.length - 3}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); deleteCollection(${item.id})" class="text-red-400 hover:text-red-300 text-xs shrink-0">åˆ é™¤</button>
                </div>
            </div>
        `).join('');
    }

    function viewCollection(id) {
        const item = collections.find(c => c.id === id);
        if (!item) return;
        
        selectedWords = [...item.words];
        currentArticle = item.article;
        updateSelectedWords();
        
        let displayContent = item.article;
        item.words.forEach(word => {
            const regex = new RegExp(`\\b(${word})\\b`, 'gi');
            displayContent = displayContent.replace(regex, '<span class="highlight-word">$1</span>');
        });
        
        document.getElementById('articleResult').innerHTML = displayContent;
        document.getElementById('usedWordsList').innerHTML = item.words.map(w => 
            `<span class="px-3 py-1 bg-gradient-to-r from-violet-600/50 to-pink-600/50 rounded-full text-sm">${w}</span>`
        ).join('');
        document.getElementById('resultSection').classList.remove('hidden');
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteCollection(id) {
        if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
        collections = collections.filter(c => c.id !== id);
        localStorage.setItem('ai_reader_collections', JSON.stringify(collections));
        renderCollections();
        showToast('ğŸ—‘ï¸ å·²åˆ é™¤');
    }

    function clearAllCollections() {
        if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ”¶è—ï¼Ÿ')) return;
        collections = [];
        localStorage.setItem('ai_reader_collections', JSON.stringify(collections));
        renderCollections();
        showToast('ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰æ”¶è—');
    }

    function showDevModal() { document.getElementById('devModal').classList.remove('hidden'); }
    function hideDevModal() { document.getElementById('devModal').classList.add('hidden'); }
    </script>
</body>
</html>
